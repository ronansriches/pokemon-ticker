<script>
const API_URL = "/api/movers"; // our proxy endpoint (stays the same)
const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes

async function fetchData() {
  try {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error(await res.text());
    const json = await res.json();
    renderTicker(json);
  } catch (err) {
    console.error(err);
    document.getElementById("ticker").textContent = "‚ö†Ô∏è Unable to load data. (Check API or proxy)";
  }
}

// Helper: draw small sparkline
function drawSpark(ctx, prices, width, height) {
  ctx.clearRect(0, 0, width, height);
  if (!prices || prices.length < 2) return;
  const min = Math.min(...prices);
  const max = Math.max(...prices);
  const scaleY = v => height - ((v - min) / ((max - min) || 1)) * height;
  ctx.beginPath();
  ctx.moveTo(0, scaleY(prices[0]));
  prices.forEach((p, i) => {
    ctx.lineTo((i / (prices.length - 1)) * width, scaleY(p));
  });
  ctx.strokeStyle = "#00ff88";
  ctx.lineWidth = 1.5;
  ctx.stroke();
}

// Renders ticker items
function renderTicker(data) {
  const ticker = document.getElementById("ticker");
  const newTicker = document.createElement("div");
  newTicker.className = "ticker";
  newTicker.id = "ticker";

  data.data.slice(0, 20).forEach(card => {
    // Pick a variant with price info
    const variant = card.variants?.find(v => v.price) || card.variants?.[0];
    if (!variant) return;

    const price = variant.price || 0;
    const change = variant.priceChange30d || 0;
    const isGain = change >= 0;
    const history = variant.priceHistory30d || variant.priceHistory7d || [];

    const div = document.createElement("div");
    div.classList.add("ticker-item", isGain ? "gain" : "loss");
    const symbol = isGain ? "‚ñ≤" : "‚ñº";
    const emoji = isGain ? "üî•" : "üìâ";
    const trend = Math.abs(change) >= 15 ? (isGain ? "üöÄ" : "üíÄ") : Math.abs(change) >= 5 ? "üî∏" : "üîπ";

    div.textContent = `${emoji} ${card.name} (${card.set.name || "Set"}) ${trend} ${symbol} ${change.toFixed(2)}% $${price.toFixed(2)}`;

    // Tooltip with sparkline
    div.addEventListener("mousemove", e => {
      const tip = getTooltip();
      let html = `<strong>${card.name}</strong><br>
                  Current: $${price.toFixed(2)}<br>
                  Change 30d: ${change.toFixed(2)}% ${symbol}<br>`;
      tip.innerHTML = html;
      drawSpark(tip.ctx, history.map(Number), tip.canvas.width, tip.canvas.height);
      tip.style.left = `${e.pageX + 15}px`;
      tip.style.top = `${e.pageY + 15}px`;
      tip.style.display = "block";
    });
    div.addEventListener("mouseleave", () => getTooltip().style.display = "none");

    // Popup with larger chart
    div.addEventListener("click", () => showPopup(card, variant, history));

    newTicker.appendChild(div);
  });

  ticker.parentElement.replaceChild(newTicker, ticker);
}

// Tooltip singleton
function getTooltip() {
  if (window.tip) return window.tip;
  const tip = document.createElement("div");
  Object.assign(tip.style, {
    position: "fixed",
    background: "rgba(0,0,0,.85)",
    color: "#fff",
    padding: "8px 10px",
    border: "1px solid #333",
    borderRadius: "6px",
    fontSize: "0.8rem",
    fontFamily: "Courier New, monospace",
    zIndex: 1000,
    display: "none"
  });
  const canvas = document.createElement("canvas");
  canvas.width = 120;
  canvas.height = 40;
  tip.ctx = canvas.getContext("2d");
  tip.canvas = canvas;
  tip.appendChild(canvas);
  document.body.appendChild(tip);
  window.tip = tip;
  return tip;
}

// Popup panel
function showPopup(card, variant, history) {
  if (!window.popup) {
    const overlay = document.createElement("div");
    Object.assign(overlay.style, {
      position: "fixed", inset: 0, background: "rgba(0,0,0,.7)",
      display: "flex", alignItems: "center", justifyContent: "center", zIndex: 2000
    });
    const box = document.createElement("div");
    Object.assign(box.style, {
      background: "#1c1c1c", padding: "20px", borderRadius: "8px",
      textAlign: "center", fontFamily: "Courier New, monospace", color: "#fff"
    });
    const img = document.createElement("img");
    Object.assign(img.style, { width: "200px", height: "280px", borderRadius: "8px", border: "1px solid #333" });
    const canvas = document.createElement("canvas");
    canvas.width = 280; canvas.height = 120; canvas.style.marginTop = "10px";
    const ctx = canvas.getContext("2d");

    box.appendChild(img);
    box.appendChild(canvas);
    overlay.appendChild(box);
    overlay.addEventListener("click", e => { if (e.target === overlay) overlay.remove(); });
    window.popup = { overlay, img, canvas, ctx };
  }
  window.popup.img.src = card.image_url || "https://via.placeholder.com/200x280?text=No+Image";
  const ctx = window.popup.ctx;
  ctx.clearRect(0, 0, 280, 120);
  if (history.length > 1) drawSpark(ctx, history.map(Number), 280, 120);
  document.body.appendChild(window.popup.overlay);
}

// Initialize
fetchData();
setInterval(fetchData, REFRESH_INTERVAL);
</script>

